!function(e, n) {
    "object" == typeof exports && "undefined" != typeof module ? module.exports = n() : "function" == typeof define && define.amd ? define(n) : e.NewsappWeixin = n()
}(this, function() {
    "use strict";
    function e(e) {
        var n = new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(e).replace(/[-.+*]/g, "\\$&") + "\\s*\\=\\s*([^;]*).*$)|^.*$");
        return decodeURIComponent(document.cookie.replace(n, "$1")) || ""
    }
    function n(e) {
        var n = wx.getStorageSync("__cookie_store__");
        if (n) {
            var o = n.find(function(n) {
                return n.name === e
            });
            return o && o.value
        }
    }
    function o(e) {
        var n = (arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : window.location.href).replace(/#.*/, "")
            , o = /\?.*/.exec(n)
            , t = {};
        return (o = o && o[0] || "").replace(/([^?=&]+)(=([^&]*))?/g, function(e, n, o, c) {
            t[decodeURIComponent(n)] = decodeURIComponent(c)
        }),
            e ? t[e] : t
    }
    var t = {
        appid: "wx48a26249513fd3a2",
        product: "newsapp_163"
    };
    function c() {
        return e("P_OINFO").split("|")[0] || o("username")
    }
    var i = {
        config: function(e) {
            t.appid = e.appid || t.appid,
                t.product = e.product || t.product
        },
        login: function(e) {
            e = e || window.location.href;
            var n = "https://reg.163.com/outerLogin/oauth2/weixin_connect.do?product=" + t.product + "&url=" + encodeURIComponent(e)
                , o = "https://c.m.163.com/html/activity/tools/newsapp-weixin-login/redirect.html?url=" + encodeURIComponent(n);
            window.location.replace("https://open.weixin.qq.com/connect/oauth2/authorize?appid=" + t.appid + "&redirect_uri=" + encodeURIComponent(o) + "&response_type=code&scope=snsapi_userinfo#wechat_redirect")
        },
        logout: function(e) {
            e = e || window.location.href,
                window.location.replace("https://reg.163.com/Logout.jsp?url=" + encodeURIComponent(e))
        },
        getUserInfo: function(e) {
            !function(e) {
                if (!(e = e || {}).url)
                    throw new Error("参数不合法");
                e.callback = e.callback || "callback",
                    e.callbackName = e.callbackName || ("jsonp_" + Math.random()).replace(".", ""),
                    e.data = e.data || {},
                    e.data[e.callback] = e.callbackName;
                var n, o = document.getElementsByTagName("head")[0], t = document.createElement("script");
                o.appendChild(t),
                    window[e.callbackName] = function(c) {
                        clearTimeout(n),
                            o.removeChild(t),
                            window[e.callbackName] = null,
                        e.success && e.success(c)
                    }
                    ,
                e.timeout && (n = setTimeout(function() {
                    o.removeChild(t),
                        window[e.callbackName] = null,
                    e.fail && e.fail({
                        message: "超时"
                    })
                }, e.timeout)),
                    t.src = e.url + "?" + function(e) {
                        var n = [];
                        for (var o in e)
                            e.hasOwnProperty(o) && n.push(encodeURIComponent(o) + "=" + encodeURIComponent(e[o]));
                        return n.join("&")
                    }(e.data)
            }({
                url: "https://c.m.163.com/nc/wechat/user/info.html",
                data: {
                    username: c()
                },
                success: function(n) {
                    n.openid ? (e.call(this, n),
                    window.NTESAntAnalysis && window.NTESAntAnalysis.sendData({
                        projectid: "NTM-BXR8M5Z5-2",
                        val_nm: "weixinLogin",
                        val_act: "weixinUserInfo",
                        info: n
                    })) : e.call(this)
                },
                fail: function() {
                    e.call(this)
                }
            })
        },
        getPassport: c,
        checkLogin: function() {
            return !!e("S_OINFO") || !!o("username")
        }
    }
        , a = {
        product: "newsapp_weapp",
        loginUrl: "https://taidu.3g.163.com/news-support/weixin/miniprogram/login",
        request: !window && wx.request
    };
    function r(e) {
        var n = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : function() {}
        ;
        wx.getSetting({
            success: function(o) {
                o.authSetting["scope.userInfo"] ? wx.getUserInfo({
                    withCredentials: !0,
                    success: function(n) {
                        var o = n.userInfo
                            , t = n.encryptedData
                            , c = n.iv;
                        e.call(this, o, t, c)
                    },
                    fail: n
                }) : n.call(this)
            },
            fail: n
        })
    }
    return window ? i : {
        config: function(e) {
            a.product = e.product || a.product,
                a.loginUrl = e.loginUrl || a.loginUrl,
                a.request = e.request || a.request
        },
        login: function(e) {
            var n = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : function() {}
            ;
            wx.login({
                success: function(o) {
                    var t = this
                        , c = o.code;
                    r(function(o, i, r) {
                        a.request({
                            url: a.loginUrl,
                            method: "POST",
                            header: {
                                "Content-Type": "application/x-www-form-urlencoded"
                            },
                            data: {
                                product: a.product,
                                code: c,
                                encryptedData: i,
                                iv: r
                            },
                            success: function(c) {
                                var i = c.statusCode
                                    , a = c.data;
                                200 !== i || 200 !== a.code && 1e4 !== a.code ? n.call(t) : e.call(t, o)
                            },
                            fail: n
                        })
                    }, n)
                },
                fail: n
            })
        },
        logout: function(e) {
            var n = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : function() {}
            ;
            a.request({
                url: "https://reg.163.com/clearcookie.jsp",
                data: {
                    domain: "163.com"
                },
                success: e,
                fail: n
            })
        },
        getUserInfo: r,
        getPassport: function() {
            return n("P_OINFO").split("|")[0]
        },
        getOpenId: function() {
            return n("MINI_PROGRAM_OPENID")
        },
        checkLogin: function() {
            return !!n("S_OINFO")
        }
    }
});
